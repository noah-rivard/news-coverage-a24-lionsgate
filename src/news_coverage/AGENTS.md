# Component Guide: `src/news_coverage/` (core workflow & services)

- Default classifier/summarizer rely on the OpenAI Responses API. `process_article` only builds a client (and therefore requires `OPENAI_API_KEY`) when those defaults are used; when injecting both tools or passing a client, it will run offline for tests.
- Injected tools must accept a `client` argument that can be `None` when you provide both classifier and summarizer; return the same dataclasses used in `workflow.py`.
- Ingest writes JSONL files under `data/ingest/{company}/{quarter}.jsonl` after schema validation; keep file paths stable so Chrome extension/back-end stay in sync.
- Ingest does not de-duplicate; repeated URLs are stored again and will produce additional final-output entries.
- Summarizer calls skip the `temperature` parameter when `SUMMARIZER_MODEL` is `gpt-5-mini` (model rejects it).
- Summarizer retries once with a truncated article body when the Responses API returns `max_output_tokens`; it still raises if the retry truncates.
- Prompt/formatter routing is declarative (`ROUTING_RULES` in `workflow.py`), matching category substrings to prompt files; if the classifier confidence is below `routing_confidence_floor` (default 0.5), the coordinator falls back to `general_news.txt` to stay safe.
- Batch summarization helper (`summarize_articles_batch` + `_extract_summary_chunks`) accepts one prompt per article and raises when the model returns fewer chunks than articles to avoid silent drops.
- Prompt templates live in `src/prompts/`; keep `workflow.PROMPTS_DIR` aligned if relocating.
- Exec-change note parsing can be toggled via `EXEC_CHANGE_NOTE_MODE`: `prefixed` (default; only attach `Note:` lines) or `unprefixed` (attach one unprefixed follow-on sentence to the exec-change fact when present). When set to `unprefixed`, exec changes route to `exec_changes_unprefixed_note.txt`.
- Content-list categories (greenlights/pickups/development/renewals/cancellations/dating) now assemble one fact per title item; a single optional follow-up note line attaches to the same fact instead of becoming its own fact. The content-formatter prompt omits manual (M/D) dates; renderers add date markers/links from `published_at`.
- Interview/commentary summaries are assembled as a single fact when the model output starts with `Interview:` or `Commentary:`; subsequent lines are kept as ordered paragraphs under that same fact (instead of becoming separate facts).
- For hybrid articles, the summarizer may emit one or more routing-override lines (e.g., `Film GNS:` / `Specials Greenlights:` / `M&A:` / `IR Quarterly Earnings:`); the workflow parses these into separate facts under the corresponding category paths regardless of the classifier’s primary category or which prompt was routed.
- Likewise, any line starting with `Exit:` / `Promotion:` / `Hiring:` / `New Role:` is always treated as an `Org -> Exec Changes` fact, enabling “AND” coverage without forcing a single routed category.
- Manager-agent path lives in `agent_runner.py` (Agents SDK). CLI defaults to `--mode agent`, with `--mode direct` retaining the legacy pipeline. Agent tools share a `PipelineContext` so classification/summarization/formatting/ingest stay in order.
- `run_with_agent_batch` enables concurrent per-article agent runs (used by the CLI `batch` command); each article still flows through classify -> summarize -> format -> ingest independently.
- Typer CLI uses the root command as the single-article runner (no `run` subcommand needed); the `build-docx` helper remains a subcommand.
- Update this guide whenever workflow behavior, storage paths, or tool signatures change so downstream services and tests remain aligned.
- Multi-title content deals (international slates) now route to `content_deals.txt` and use the `format_content_deals` formatter, which preserves multiple titles and ensures any date marker is hyperlinked to the article URL (it appends the publish date when missing and ignores unrelated parentheses such as subtitles).
- Ingest server CORS: `CORS_ALLOW_ALL` defaults to true; if origins resolve to `*` we automatically disable credentials to satisfy Starlette's wildcard+credentials restriction. To permit credentials, set explicit origins via `CORS_ALLOW_ORIGINS` and leave `CORS_ALLOW_CREDENTIALS=true` (default).
- The FastAPI server exposes `/process/article` for single-article runs and `/process/articles` for batch runs; the batch endpoint accepts a JSON array or `{ "articles": [...] }`, supports a `concurrency` value, and returns per-item status plus counts.
- Multi-buyer DOCX generation is handled via `coverage_builder.py` and `docx_builder.py`, invoked through `python -m news_coverage.cli build-docx`. It relies on keyword-based buyer routing (`buyer_routing.py`) and writes outputs to `docs/samples/news_coverage_docx/`; keep these paths and rules in sync with README/CHANGELOG.
- DOCX builder renders Content/Strategy sections as grouped subheadings (bold "No Spacing" paragraphs) and uses fact-level title lines for content-list entries, emitting any attached note lines as follow-on paragraphs.
- For entry titles that start with `Interview:` or `Commentary:`, DOCX rendering italicizes the label and bolds the remainder of the header line to match the reference style more closely.
- Buyer routing regexes use word-character lookarounds (`(?<!\\w)` / `(?!\\w)`) to avoid substring matches (e.g., "max" should not match "maxwell"); keep lookarounds intact when editing keyword logic.
- Company inference now uses position-aware scoring to prefer title/lead matches over body-only mentions; buyer priority breaks ties.
- Final-output "Matched buyers" display now uses strong matches (title/lead/URL host) plus the primary company, excluding body-only mentions from that list.
- Article title/content are normalized for common mojibake before classification and summarization, with a brief note recorded in agent traces when enabled.
- Manager-agent runs can append a plain-text trace log when `AGENT_TRACE_PATH` is set (or the CLI `--trace`/`--trace-path` flags); the log captures raw article content, tool calls/outputs, and the final markdown to help debug truncation issues.
- JSONL ingest writes, final-output appends, and trace logs are guarded with process-local file locks so parallel runs do not interleave writes.
