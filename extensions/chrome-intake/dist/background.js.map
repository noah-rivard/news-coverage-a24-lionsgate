{
  "version": 3,
  "sources": ["../src/background.ts"],
  "sourcesContent": ["// Service worker: stores the latest scraped article and sends to ingest API.\n\nconst DEFAULT_ENDPOINT = \"http://localhost:8000/ingest/article\";\nconst CONTEXT_MENU_ID = \"capture-article\";\nconst CAPTURE_TIMEOUT_MS = 20000; // fail fast if a background tab hangs\n\ntype ArticlePayload = {\n  title: string;\n  source: string;\n  url: string;\n  published_at?: string;\n  content?: string;\n};\n\ntype StoredArticle = ArticlePayload & { scrapedAt: string };\n\nfunction deriveQuarter(publishedAt?: string, scrapedAt?: string): string {\n  const source = publishedAt || scrapedAt;\n  if (source) {\n    const datePart = source.split(\"T\")[0];\n    const [yearStr, monthStr] = datePart.split(\"-\");\n    const year = Number(yearStr);\n    const month = Number(monthStr);\n    if (Number.isFinite(year) && Number.isFinite(month) && month >= 1 && month <= 12) {\n      const quarter = Math.floor((month - 1) / 3) + 1;\n      return `${year} Q${quarter}`;\n    }\n  }\n\n  const now = new Date();\n  const quarter = Math.floor(now.getMonth() / 3) + 1;\n  return `${now.getFullYear()} Q${quarter}`;\n}\n\nfunction resolvePublishedDate(publishedAt?: string, scrapedAt?: string): string | undefined {\n  if (publishedAt) {\n    return publishedAt;\n  }\n\n  if (scrapedAt) {\n    const datePart = scrapedAt.split(\"T\")[0];\n    if (datePart) {\n      return datePart;\n    }\n  }\n\n  return undefined;\n}\n\nasync function getEndpoint(): Promise<string> {\n  const { ingestEndpoint } = await chrome.storage.sync.get({\n    ingestEndpoint: DEFAULT_ENDPOINT,\n  });\n  return ingestEndpoint || DEFAULT_ENDPOINT;\n}\n\nasync function ensureHostPermissionForUrl(rawUrl: string): Promise<boolean> {\n  try {\n    const u = new URL(rawUrl);\n    const originPattern = `${u.protocol}//${u.host}/*`;\n    const alreadyGranted = await chrome.permissions.contains({ origins: [originPattern] });\n    if (alreadyGranted) return true;\n    // Must be called during a user gesture (context menu click qualifies).\n    return await chrome.permissions.request({ origins: [originPattern] });\n  } catch (err) {\n    console.warn(\"ensureHostPermissionForUrl: invalid url\", rawUrl, err);\n    return false;\n  }\n}\n\nfunction notifyCaptureFailure(reason: string) {\n  chrome.runtime.sendMessage({ type: \"CAPTURE_FAILED\", reason }).catch(() => {\n    /* no listeners; best-effort */\n  });\n}\n\nfunction ensureContextMenu() {\n  chrome.contextMenus.removeAll(() => {\n    chrome.contextMenus.create(\n      {\n        id: CONTEXT_MENU_ID,\n        title: \"Capture article for ingest\",\n        contexts: [\"page\", \"frame\", \"link\"],\n      },\n      () => {\n        const err = chrome.runtime.lastError;\n        if (err && !err.message.includes(\"duplicate id\")) {\n          console.warn(\"Failed to create context menu\", err.message);\n        }\n      }\n    );\n  });\n}\n\nensureContextMenu();\nchrome.runtime.onInstalled.addListener(ensureContextMenu);\nchrome.runtime.onStartup.addListener(ensureContextMenu);\n\nchrome.runtime.onMessage.addListener((message, _sender, sendResponse) => {\n  if (message?.type === \"ARTICLE_SCRAPED\") {\n    const article: StoredArticle = {\n      ...message.payload,\n      scrapedAt: new Date().toISOString(),\n    };\n    chrome.storage.local.set({ latestArticle: article });\n    sendResponse({ status: \"stored\" });\n    return true;\n  }\n\n  if (message?.type === \"GET_LATEST_ARTICLE\") {\n    chrome.storage.local.get(\"latestArticle\").then((data) => {\n      sendResponse({ article: data.latestArticle });\n    });\n    return true;\n  }\n\n  if (message?.type === \"SEND_TO_INGEST\") {\n    chrome.storage.local.get(\"latestArticle\").then(async (data) => {\n      const article: StoredArticle | undefined = data.latestArticle;\n      if (!article) {\n        sendResponse({ status: \"error\", error: \"No article scraped yet.\" });\n        return;\n      }\n      const endpoint = await getEndpoint();\n      try {\n        const body = {\n          company: \"Unknown\",\n          quarter: deriveQuarter(article.published_at, article.scrapedAt),\n          section: \"Strategy & Miscellaneous News\",\n          subheading: \"General News & Strategy\",\n          title: article.title,\n          source: article.source || \"Unknown\",\n          url: article.url,\n          published_at: resolvePublishedDate(article.published_at, article.scrapedAt),\n          body: article.content || \"\",\n          ingest_source: \"chrome_extension\",\n        };\n        const resp = await fetch(endpoint, {\n          method: \"POST\",\n          headers: { \"Content-Type\": \"application/json\" },\n          body: JSON.stringify(body),\n        });\n        if (!resp.ok) {\n          const detail = await resp.text();\n          sendResponse({\n            status: \"error\",\n            error: `Ingest failed: ${resp.status} ${detail}`,\n          });\n          return;\n        }\n        sendResponse({ status: \"ok\" });\n      } catch (err: any) {\n        sendResponse({ status: \"error\", error: err?.message || String(err) });\n      }\n    });\n    return true;\n  }\n\n  return undefined;\n});\n\nchrome.contextMenus.onClicked.addListener((info, tab) => {\n  (async () => {\n    if (info.menuItemId !== CONTEXT_MENU_ID || !tab?.id) {\n      return;\n    }\n\n    const frameUrl = info.frameUrl;\n    const targetUrl = info.linkUrl || frameUrl || info.pageUrl || tab.url;\n    if (!targetUrl) {\n      console.warn(\"No target URL available for capture.\");\n      notifyCaptureFailure(\"No URL available to capture.\");\n      return;\n    }\n\n    // Capture in same tab when clicking page/frame; use background tab for links to avoid disrupting user.\n    const useBackgroundTab = Boolean(info.linkUrl);\n    // Request permission for the actual frame origin when scraping an embedded article.\n    const permissionTarget = useBackgroundTab ? targetUrl : frameUrl || targetUrl;\n\n    const granted = await ensureHostPermissionForUrl(permissionTarget);\n    if (!granted) {\n      console.warn(\"Capture cancelled: site permission was denied for\", permissionTarget);\n      notifyCaptureFailure(\"Site permission was denied.\");\n      return;\n    }\n\n    if (useBackgroundTab) {\n      captureInBackgroundTab(targetUrl);\n      return;\n    }\n\n    const frameId = typeof info.frameId === \"number\" ? info.frameId : 0;\n    try {\n      await chrome.scripting.executeScript({\n        target: { tabId: tab.id!, frameIds: [frameId] },\n        files: [\"contentScript.js\"],\n      });\n    } catch (err: any) {\n      const message = err?.message || String(err);\n      console.warn(\"Failed to inject content script into frame\", permissionTarget, message);\n      notifyCaptureFailure(\"Could not access the embedded article. Please grant frame permission and try again.\");\n    }\n  })().catch((err) => {\n    console.warn(\"Unexpected error handling capture click\", err);\n    notifyCaptureFailure(\"Capture failed unexpectedly. Please try again.\");\n  });\n});\n\nasync function captureInBackgroundTab(url: string) {\n  const tab = await chrome.tabs.create({ url, active: false });\n  const tabId = tab.id;\n  if (!tabId) return;\n\n  const timeout = setTimeout(() => {\n    chrome.tabs.remove(tabId).catch(() => undefined);\n  }, CAPTURE_TIMEOUT_MS);\n\n  // Wait briefly for load; MV3 does not allow synchronous tab load waits, so use onUpdated listener.\n  const injectAndClose = async () => {\n    try {\n      await chrome.scripting.executeScript({\n        target: { tabId },\n        files: [\"contentScript.js\"],\n      });\n    } finally {\n      clearTimeout(timeout);\n      chrome.tabs.remove(tabId).catch(() => undefined);\n    }\n  };\n\n  const listener = async (updatedTabId: number, changeInfo: chrome.tabs.TabChangeInfo) => {\n    if (updatedTabId !== tabId || changeInfo.status !== \"complete\") return;\n    chrome.tabs.onUpdated.removeListener(listener);\n    await injectAndClose();\n  };\n\n  chrome.tabs.onUpdated.addListener(listener);\n\n  // If the tab is already complete (rare but possible), inject immediately.\n  chrome.tabs.get(tabId).then((t) => {\n    if (t.status === \"complete\") {\n      chrome.tabs.onUpdated.removeListener(listener);\n      injectAndClose();\n    }\n  });\n}\n"],
  "mappings": "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",
  "names": ["quarter"]
}
